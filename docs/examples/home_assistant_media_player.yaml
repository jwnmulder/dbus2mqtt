dbus:
  subscriptions:

    - bus_name: org.mpris.MediaPlayer2.*
      path: /org/mpris/MediaPlayer2
      # https://mpris2.readthedocs.io/en/latest/interfaces.html#mpris2.MediaPlayer2

      interfaces:
        - interface: org.freedesktop.DBus.Properties
          signals:
            - signal: PropertiesChanged
              filter: "{{ args[0] == 'org.mpris.MediaPlayer2.Player' }}"
          methods:
            - method: GetAll

        - interface: org.mpris.MediaPlayer2
          mqtt_command_topic: dbus2mqtt/org.mpris.MediaPlayer2/command
          methods:
            - method: Quit

        - interface: org.mpris.MediaPlayer2.Player
          mqtt_command_topic: dbus2mqtt/org.mpris.MediaPlayer2/command
          signals:
            - signal: Seeked
          methods:
            - method: Play
            - method: Pause
            - method: PlayPause
            - method: Stop
            - method: Next
            - method: Previous
            - method: Seek
            - method: SetPosition
            - method: OpenUri
          properties:
            - property: Volume

      flows:
        - name: publish player state
          triggers:
            - type: dbus_object_added
            - type: schedule
              interval: {seconds: 5}
            - type: dbus_signal
              interface: org.freedesktop.DBus.Properties
              signal: PropertiesChanged
              # filter: "{{ args[0] == 'org.mpris.MediaPlayer2.Player' }}"
            - type: dbus_signal
              interface: org.mpris.MediaPlayer2.Player
              signal: Seeked
            - type: context_changed
          conditions:
            - "{{ dbus_list('org.mpris.MediaPlayer2.*') | length > 0 }}"
          actions:
            - type: context_set
              context:
                mpris_bus_name: '{{ current_player_bus_name | default(dbus_list("org.mpris.MediaPlayer2.*") | first, true) }}'
                mpris_path: /org/mpris/MediaPlayer2
                available_players: "{{ dbus_list('org.mpris.MediaPlayer2.*') | map('replace', 'org.mpris.MediaPlayer2.', '') | list }}"
                # Some players return stale position if GetAll is executed immediately after a seeked signal.
                # By storing the seeked position it can be used to override Position below
                seeked_position: '{{ args[0] if trigger_type == "dbus_signal" and signal == "Seeked" else None }}'
            - type: context_set
              context:
                current_player: "{{ mpris_bus_name | replace('org.mpris.MediaPlayer2.', '') }}"
                player_properties: |
                  {{ dbus_call(mpris_bus_name, mpris_path, 'org.freedesktop.DBus.Properties', 'GetAll', ['org.mpris.MediaPlayer2.Player']) }}
            - type: mqtt_publish
              topic: dbus2mqtt/org.mpris.MediaPlayer2/state
              payload_type: json
              payload_template: |
                {% set metadata = player_properties.get('Metadata') or {} %}
                {% set metadata_xesam_url = metadata.get('xesam:url', '') | urldecode %}
                {{
                    {
                      'current_bus_name': mpris_bus_name,
                      'current_player': current_player,
                      'available_players': available_players
                    }
                    | combine(player_properties)
                    | combine({ 'Position': seeked_position } if seeked_position else {})
                    | combine({ 'Metadata': { 'xesam:url': metadata_xesam_url } }, recursive=True)
                }}

        # mpris:artUrl can have a file:// or http:// schema
        # Home Assistant is unable to access file:// so we use MQTT for that
        - name: publish local art image
          triggers:
            - type: dbus_object_added
            - type: dbus_signal
              interface: org.freedesktop.DBus.Properties
              signal: PropertiesChanged
            - type: context_changed
          conditions:
            - "{{ dbus_list('org.mpris.MediaPlayer2.*') | length > 0 }}"
          actions:
            - type: context_set
              context:
                mpris_bus_name: '{{ current_player_bus_name | default(dbus_list("org.mpris.MediaPlayer2.*") | first, true) }}'
                mpris_path: /org/mpris/MediaPlayer2
            - type: context_set
              context:
                artUrl: "{{ (dbus_property_get(mpris_bus_name, mpris_path, 'org.mpris.MediaPlayer2.Player', 'Metadata') or {}).get('mpris:artUrl') if mpris_bus_name else None }}"
            - type: mqtt_publish
              topic: dbus2mqtt/org.mpris.MediaPlayer2/artUrlImage
              payload_type: binary
              payload_template: |
                {{ artUrl if artUrl and artUrl.startswith('file://') else None }}

        # When the last MPRIS player is gone, publish off state and reset image
        - name: player removed
          triggers:
            - type: dbus_object_removed
          conditions:
            - "{{ dbus_list('org.mpris.MediaPlayer2.*') | length == 0 }}"
          actions:
            - type: mqtt_publish
              topic: dbus2mqtt/org.mpris.MediaPlayer2/state
              payload_type: json
              payload_template:
                PlaybackStatus: "Off"
            - type: mqtt_publish
              topic: dbus2mqtt/org.mpris.MediaPlayer2/artUrlImage
              payload_type: binary
              payload_template: "{{ None }}"

        - name: Set current player
          triggers:
            - type: mqtt_message
              topic: dbus2mqtt/org.mpris.MediaPlayer2/custom_command
              filter: "{{ payload.get('action') == 'set_current_player' }}"
            - type: object_removed
            # TODO: When second player is removed the scheduler stops triggering flows. Needs to be fixed
          actions:
            - type: context_set
              context:
                preferred_player: >-
                  {% set preferred_player = current_player_bus_name | default(None) -%}
                  {% if trigger_type == 'mqtt_message' -%}
                  {%   set preferred_player = 'org.mpris.MediaPlayer2.' + payload.get('player') -%}
                  {% endif -%}
                  {{ preferred_player }}
            - type: context_set
              global_context:
                current_player_bus_name: >-
                  {{ preferred_player if preferred_player in dbus_list('org.mpris.MediaPlayer2.*') else None }}
            - type: log
              msg: Changed preferred player to '{{ current_player_bus_name }}', requested '{{ preferred_player }}'

        - name: Home Assistant Discovery
          triggers:
            - type: dbus_object_added
          actions:
            - type: mqtt_publish
              topic: homeassistant/device/mpris-E8EB9686/config
              payload_type: json
              payload_template:
                device:
                  identifiers:
                    - mpris-E8EB9686
                  name: MPRIS Media Player
                  model: MPRIS Media Player
                  manufacturer: dbus2mqtt
                  sw_version: "{{ dbus2mqtt.version }}"
                origin:
                  name: dbus2mqtt
                components:
                  player_state:
                    platform: sensor
                    name: State
                    unique_id: e8eb9686-f947-46e1-80d4-fc1e812e39a2
                    state_topic: dbus2mqtt/org.mpris.MediaPlayer2/state
                    value_template: >-
                      {% raw %}
                      {% set status = value_json.PlaybackStatus %}
                      {{ {'Playing': 'playing', 'Paused': 'paused', 'Stopped': 'idle'}.get(status, 'off') }}
                      {% endraw %}
                    json_attributes_topic: dbus2mqtt/org.mpris.MediaPlayer2/state
                    json_attributes_template: >
                      {% raw %}
                      {% set metadata = value_json.get('Metadata') or {} %}
                      {% set mpris_art_url = metadata.get('mpris:artUrl', '') %}
                      {% set xesam_artists = metadata.get('xesam:artist', ['']) %}
                      {% set xesam_url = metadata.get('xesam:url') %}

                      {% set artists = [xesam_artists] if xesam_artists is string else xesam_artists %}

                      {# title: 'xesam:title' or filename without extension from 'xesam:url' #}
                      {% set title = metadata.get('xesam:title', '') %}
                      {% if not title or title == '' %}
                      {%    set title = xesam_url | regex_findall(find='([^\\/]+?)(?:\.[^.\\/]+)?$') | first | default('') %}
                      {% endif %}

                      {% set media_image_url = mpris_art_url %}
                      {% if xesam_url.startswith('https://www.youtube.com/watch?v=') %}
                      {%    set media_image_url = xesam_url | regex_replace(
                              find='https:\/\/www\\.youtube\\.com\/watch\\?v=([^&]+).*',
                              replace='https://img.youtube.com/vi/\\1/maxresdefault.jpg'
                            ) %}
                      {% endif %}

                      {{
                        value_json | combine({
                          "MediaDuration": ((metadata.get('mpris:length') or 0) / 1000000) | int,
                          "MediaPosition": ((value_json.get('Position') or 0) / 1000000) | int,
                          "MediaTitle": title,
                          "MediaAlbum": metadata.get('xesam:album', ''),
                          "MediaArtists": artists | join(', '),
                          "MediaImageUrl": media_image_url,
                          "VolumeMuted": value_json.get('Volume') == 0
                        }) | to_json
                      }}
                      {% endraw %}
                  image:
                    platform: image
                    name: Image
                    unique_id: 22c9206e-4af3-47d8-ac01-c23d62e43177
                    image_topic: dbus2mqtt/org.mpris.MediaPlayer2/artUrlImage
